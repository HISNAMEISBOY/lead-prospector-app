<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Lead Prospector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f5; 
        }
        /* Style for the JSON pre block - hide by default for cleaner look */
        #jsonOutput:not(.active) {
            max-height: 0;
            opacity: 0;
            padding: 0 1rem;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
        #jsonOutput.active {
            max-height: 500px; 
            opacity: 1;
            padding: 1rem;
            transition: max-height 0.5s ease-in, opacity 0.5s ease-in;
        }
        
        /* Enforce text brevity for the reason description in the card */
        .reason-cell {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="app" class="max-w-7xl mx-auto bg-white shadow-2xl rounded-2xl p-6 md:p-10 border border-gray-100">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 flex items-center">
                <svg class="w-8 h-8 md:w-10 md:h-10 text-indigo-600 mr-3 transform rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Lead Prospecting Engine
            </h1>
            <p class="text-gray-500 mt-2 text-base md:text-lg">Identify and score local businesses based on their urgent need for a modern website.</p>
        </header>

        <section class="mb-10 p-4 md:p-6 bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">
            <label for="nicheInput" class="block text-base font-semibold text-gray-700 mb-3">
                Target Market (Location and Industry Niche)
            </label>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <input
                    type="text"
                    id="nicheInput"
                    class="flex-grow p-3 md:p-4 border-2 border-indigo-300 rounded-xl shadow-lg focus:ring-indigo-600 focus:border-indigo-600 text-gray-700 placeholder-gray-400"
                    placeholder="Enter your target niche (e.g., Plumbers in Durban or Bakeries in London)"
                >
                <button
                    id="generateButton"
                    class="w-full md:w-60 px-6 py-3 md:py-4 text-white font-bold rounded-xl shadow-xl 
                           bg-gradient-to-r from-indigo-600 to-blue-700 
                           hover:from-indigo-700 hover:to-blue-800 
                           transform transition duration-300 ease-in-out hover:scale-[1.01] disabled:from-gray-400 disabled:to-gray-500 disabled:shadow-md"
                >
                    Generate 10 Leads
                </button>
            </div>
        </section>

        <div id="loadingIndicator" class="hidden text-center p-12">
            <div class="flex items-center justify-center space-x-3">
                <div class="w-5 h-5 rounded-full animate-bounce bg-indigo-600"></div>
                <div class="w-5 h-5 rounded-full animate-bounce bg-blue-700 delay-75"></div>
                <div class="w-5 h-5 rounded-full animate-bounce bg-indigo-600 delay-150"></div>
                <span class="text-xl font-medium text-gray-600 ml-4">Analyzing public data and scoring leads...</span>
            </div>
        </div>

        <section id="resultsSection" class="hidden">
            <h2 id="resultsHeader" class="text-2xl font-semibold text-gray-800 mb-6">Top Prospects Found (10 Businesses)</h2>
            
            <!-- Card Grid Container -->
            <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards will be injected here by JavaScript -->
            </div>
            <!-- End Card Grid Container -->

            <!-- Generate More Button Section -->
            <div class="mt-8 pt-4 border-t border-gray-200 flex justify-center">
                <button
                    id="generateMoreButton"
                    class="px-8 py-3 text-indigo-600 font-bold rounded-xl border-2 border-indigo-600 shadow-md 
                           hover:bg-indigo-600 hover:text-white transition duration-300 disabled:border-gray-400 disabled:text-gray-400 disabled:bg-white"
                >
                    Generate 10 More Leads
                </button>
            </div>
            <!-- End Generate More Button Section -->


            <!-- Investigation Output Area -->
            <div id="investigationOutput" class="hidden mt-6 p-4 bg-blue-50 border-2 border-blue-300 rounded-xl text-gray-800 shadow-md">
                <p class="font-semibold text-blue-700 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM8.707 12.707a1 1 0 001.414 0L12 10.414V14a1 1 0 102 0V9a1 1 0 00-1-1h-5a1 1 0 000 2h2.586l-2.293 2.293a1 1 0 000 1.414z" clip-rule="evenodd"></path></svg>
                    Investigate Lead: Copy Link Below
                </p>
                <p class="text-sm">
                    **Action Required:** Due to security restrictions in this environment, please **copy the URL** below and paste it into a new browser tab to perform the search.
                </p>
                <code id="searchUrlDisplay" class="block mt-3 p-3 text-sm bg-blue-200 rounded-lg select-all cursor-copy break-all"></code>
            </div>
            
            <div class="mt-8">
                <button id="toggleJsonButton" class="text-sm text-gray-600 hover:text-indigo-600 font-medium flex items-center">
                    View Raw JSON Data
                    <svg id="chevronIcon" class="w-4 h-4 ml-1 transform transition duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <pre id="jsonOutput" class="bg-gray-800 text-green-300 rounded-xl overflow-x-auto text-sm mt-2"></pre>
            </div>
        </section>
        
        <p id="errorMsg" class="text-indigo-700 font-semibold p-4 hidden border-2 border-indigo-300 bg-indigo-100 rounded-lg mt-6 shadow-md"></p>
    </div>
    
    <!-- Full Reason Modal/Overlay -->
    <div id="reasonModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">Reason for Website Project</h3>
            <p id="modalReasonContent" class="text-gray-700 mb-6 whitespace-pre-wrap"></p>
            <button id="closeModalButton" class="w-full py-3 text-white font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition">Close</button>
        </div>
    </div>


    <script type="module">
        // --- STANDARD FIREBASE SETUP (Ignored for this specific app's logic) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const nicheInput = document.getElementById('nicheInput');
        const generateButton = document.getElementById('generateButton');
        const generateMoreButton = document.getElementById('generateMoreButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsSection = document.getElementById('resultsSection');
        const cardsContainer = document.getElementById('cardsContainer');
        const jsonOutput = document.getElementById('jsonOutput');
        const errorMsg = document.getElementById('errorMsg');
        const toggleJsonButton = document.getElementById('toggleJsonButton');
        const chevronIcon = document.getElementById('chevronIcon');
        const investigationOutput = document.getElementById('investigationOutput');
        const searchUrlDisplay = document.getElementById('searchUrlDisplay');
        const resultsHeader = document.getElementById('resultsHeader');
        const reasonModal = document.getElementById('reasonModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalReasonContent = document.getElementById('modalReasonContent');

        // --- SIMULATION DATA (Fallback) ---
        const SIMULATED_LEADS = [
            { "business_name": "Sandown Wholesale Nursery", "industry": "Horticulture / Wholesale Retail", "location": "Klein Dassenberg, Cape Town", "website_found": "no", "website_link": null, "website_age_hint": "unknown", "reason": "High-inventory, B2B-focused business with no discoverable website. Massively misses out on presenting a plant catalogue, project portfolio, or wholesale pricing online, limiting customer conversion opportunities.", "contact_hint": "Phone: 082 722 2077", "lead_score": 95 },
            { "business_name": "The Power and The Glory", "industry": "Bar / Casual Eatery", "location": "Tamboerskloof, Cape Town", "website_found": "no", "website_link": null, "website_age_hint": "unknown", "reason": "Highly popular local spot that relies entirely on social media/listings. Needs an official website for publishing current menus, hosting event schedules, and capturing email subscribers to avoid platform risk.", "contact_hint": "Phone: 021 213 1221", "lead_score": 90 },
            { "business_name": "Heaven Coffee", "industry": "Coffee Shop / Café", "location": "Cape Town", "website_found": "yes", "website_link": "https://heavenlycoffees.com/pages/restaurant-menu", "website_age_hint": "likely_old", "reason": "The site link goes to a generic sub-page of an *online machine store*, not a proper café/restaurant site. Needs a unique, branded web presence with a compelling visual menu and atmosphere that matches its local reputation.", "contact_hint": "Email/Phone for the online store, not the local café.", "lead_score": 85 },
            { "business_name": "UFCC", "industry": "Construction Supplies / Cladding", "location": "Parow Industria, Cape Town", "website_found": "yes", "website_link": "https://ufcc.co.za/", "website_age_hint": "likely_old", "reason": "A technical B2B supplier requires a professional site to reinforce trust. The current design is functional but generic and needs to feature technical data sheets, project case studies, and compliance info more prominently to capture enterprise clients.", "contact_hint": "Phone: 021 933 0052", "lead_score": 80 },
            { "business_name": "The Papery", "industry": "Stationery / Online Retail", "location": "Cape Town", "website_found": "yes", "website_link": "https://thepapery.co.za/", "website_age_hint": "likely_new", "reason": "E-commerce site with poor UX (busy layout, repetitive calls to action). A modern redesign would streamline navigation, enhance product visibility, and boost conversion rates through a cleaner, more intuitive mobile experience.", "contact_hint": "No public phone on snippet; relies on customer service email/chat.", "lead_score": 65 }
        ];
        // --- END SIMULATION DATA ---

        /**
         * Core function to generate leads by calling the Gemini API with Google Search grounding.
         */
        async function simulateGoogleSearch(query) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // --- AI PROMPT DEFINITIONS (The "Code Talk") ---
            
            // 1. System Instruction: Defines the AI's role, safety, and STRICT output format. (Slightly improved for JSON stability)
            const systemPrompt = "You are a lead generation analyst. Your task is to execute the Google Search and return the requested structured JSON array. **CRITICAL: You must output ONLY the JSON array, beginning with '[' and ending with ']' (no markdown, no conversation, no explanation, no surrounding text whatsoever) and STRICTLY adhere to the JSON schema.** Filter and exclude any business or content related to pornography, adult services, gambling, illegal activities, or hacking. You must find up to 10 businesses.";

            // 2. User Query: Contains the specific task, search niche, and the explicit scoring logic.
            const userQuery = `Find **up to 10** small, independent, and relevant businesses near the location/niche: "${query}". Only return results for businesses that are truly qualified leads (small, locally focused, and either missing or having a poor website). For the lead_score (0-100): **Determine the score such that any business with a missing website ('website_found: "no"') or a severely outdated website is scored 85 or higher.** Score between 70-84 if the website is clearly old/generic. Score 69 or below if the website looks new/functional. The higher the score, the higher the website need. Return ONLY a single JSON array formatted exactly as requested by the user.`;

            // --- END PROMPT DEFINITIONS ---


            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "business_name": { "type": "STRING" },
                                "industry": { "type": "STRING" },
                                "location": { "type": "STRING" },
                                "website_found": { "type": "STRING", "enum": ["yes", "no"] },
                                "website_link": { "type": ["string", "null"] },
                                "website_age_hint": { "type": "STRING", "enum": ["unknown", "likely_old", "likely_new"] },
                                "reason": { "type": "STRING" },
                                "contact_hint": { "type": "STRING" },
                            "lead_score": { "type": "NUMBER" }
                            },
                            required: ["business_name", "industry", "location", "website_found", "website_link", "website_age_hint", "reason", "contact_hint", "lead_score"]
                        }
                    }
                }
            };

            // Simplified fetch with simulated exponential backoff (for presentation purposes)
            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    // The text part should contain the JSON string
                    let jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (jsonString) {
                         // *** CRITICAL FIX: Aggressively strip surrounding text/markdown/newlines ***
                         // Find the first '[' and the last ']' to isolate the JSON array
                         const start = jsonString.indexOf('[');
                         const end = jsonString.lastIndexOf(']');

                         if (start !== -1 && end !== -1 && end > start) {
                            jsonString = jsonString.substring(start, end + 1).trim();
                         } else {
                            // If brackets aren't found (e.g., model returned empty text), fail gracefully.
                            throw new Error("Could not locate valid JSON array markers.");
                         }
                         // End CRITICAL FIX

                         console.log("Raw API Response Text (for debugging JSON parsing issue):", jsonString);
                         return JSON.parse(jsonString);
                    }
                    throw new Error("API returned an invalid or empty JSON response.");

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        // FINAL ATTEMPT FAILED: Provide clearer user feedback before loading fallback
                        console.warn("API failed after retries. Using simulated fallback data.");
                        throw new Error("Failed to get live leads. The API search service is currently unavailable or the query was too broad/specific.");
                    }
                }
            }
        }

        /**
         * Defines the core business logic for lead classification and returns all associated styles.
         */
        function getScoreStyles(score) {
            let color = 'text-gray-900';
            let badgeStyle = 'bg-gray-200 text-gray-700';
            let hoverBg = 'hover:bg-gray-100'; 
            let leadType = 'COLD LEAD'; 

            if (score >= 85) { 
                // HOT LEAD (Score 85-100: Highest Need - Missing or Critically Broken Site)
                color = 'text-green-700 font-extrabold'; 
                badgeStyle = 'bg-green-500 text-white';
                hoverBg = 'hover:bg-green-100'; 
                leadType = 'HOT LEAD';
            } else if (score >= 70) {
                // WARM LEAD (Score 70-84: Medium Need - Outdated or Generic Site)
                color = 'text-orange-600 font-bold'; 
                badgeStyle = 'bg-yellow-400 text-white';
                hoverBg = 'hover:bg-yellow-100'; 
                leadType = 'WARM LEAD';
            } else {
                // COLD LEAD (Score 0-69: Low Need - Functional/Modern Site)
                color = 'text-red-600 font-semibold'; 
                badgeStyle = 'bg-red-400 text-white';
                hoverBg = 'hover:bg-red-100'; 
                // leadType defaults to 'COLD LEAD'
            }
            return { color, hoverBg, badgeStyle, leadType };
        }
        
        // Function to display the full reason in a modal
        window.showFullReason = (reasonText) => {
            modalReasonContent.textContent = reasonText;
            reasonModal.classList.remove('hidden');
        }

        // New function to handle the investigation click
        window.investigateLead = (businessName, location) => {
            const encodedQuery = encodeURIComponent(`${businessName} ${location}`);
            const googleSearchUrl = `https://www.google.com/search?q=${encodedQuery}`;
            
            searchUrlDisplay.textContent = googleSearchUrl;
            investigationOutput.classList.remove('hidden');

            // Scroll to the investigation box for better UX
            investigationOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }


        function renderResults(leads) {
            // Update the header to reflect the dynamic count
            resultsHeader.textContent = `Top Prospects Found (${leads.length} Businesses)`;

            // Clear previous results
            cardsContainer.innerHTML = '';
            jsonOutput.textContent = JSON.stringify(leads, null, 2);
            investigationOutput.classList.add('hidden'); // Hide investigation output on new results

            leads.forEach(lead => {
                // Destructure all required elements, including the leadType string
                const { color, hoverBg, badgeStyle, leadType } = getScoreStyles(lead.lead_score);
                
                const isNoWebsite = lead.website_found === 'no';
                
                let websiteStatusText;
                if (isNoWebsite) {
                    websiteStatusText = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 border border-red-300">MISSING</span>`;
                } else if (lead.website_age_hint === 'likely_old') {
                     websiteStatusText = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-300">OUTDATED</span>`;
                } else {
                    websiteStatusText = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 border border-green-300">FOUND</span>`;
                }

                // Lead Type Text is now sourced directly from getScoreStyles via leadType variable
                
                const linkText = lead.website_link ? 
                    `<a href="${lead.website_link}" target="_blank" class="text-blue-500 hover:text-blue-700 underline text-xs break-all block mt-1">${lead.website_link}</a>` :
                    '<span class="text-gray-400 text-xs mt-1 block">No public link found</span>';

                // Brevity Logic
                const maxReasonLength = 120; // Aim for 2-3 lines
                const fullReason = lead.reason;
                let displayedReason = fullReason;
                let moreButton = '';

                if (fullReason.length > maxReasonLength) {
                    // Find a clean break point
                    let breakpoint = fullReason.substring(0, maxReasonLength).lastIndexOf(' ');
                    if (breakpoint === -1) breakpoint = maxReasonLength; // Fallback if no space found
                    
                    displayedReason = fullReason.substring(0, breakpoint).trim() + '...';
                    
                    // Sanitize the string for use in the onclick handler
                    const safeReason = fullReason.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    
                    moreButton = `
                        <button 
                            onclick="showFullReason('${safeReason}')"
                            class="text-blue-500 hover:text-blue-700 text-xs font-semibold mt-1 block"
                        >
                            More &raquo;
                        </button>
                    `;
                }

                
                const card = document.createElement('div');
                card.className = `p-6 rounded-xl shadow-xl border border-gray-200 bg-white flex flex-col justify-between transform hover:scale-[1.01] ${hoverBg} transition duration-200`;
                
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-xl font-bold text-gray-900 leading-tight">${lead.business_name}</h3>
                            <div class="text-right flex-shrink-0 ml-4">
                                <div class="text-3xl ${color} font-extrabold leading-none">${lead.lead_score}</div>
                                <span class="text-xs font-medium ${badgeStyle} rounded-md px-2 py-0.5 mt-1 block">
                                    ${leadType}
                                </span>
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-2">${lead.industry}</p>
                        
                        <!-- Location & Contact -->
                        <div class="text-xs text-gray-500 mb-4 space-y-1">
                            <p class="flex items-center">
                                <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                ${lead.location}
                            </p>
                            <p class="flex items-center">
                                <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                ${lead.contact_hint || 'N/A'}
                            </p>
                        </div>

                        <!-- Web Status & Link -->
                        <div class="mb-4">
                            <p class="text-sm font-semibold text-gray-700 mb-1">Web Presence:</p>
                            <div class="flex items-center space-x-2 flex-wrap">
                                ${websiteStatusText}
                                ${linkText}
                            </div>
                        </div>

                        <!-- Reason -->
                        <div class="border-t pt-3 mt-3">
                            <p class="text-sm font-semibold text-gray-700 mb-1">Project Need:</p>
                            <div class="text-sm text-gray-700 reason-cell">
                                ${displayedReason}
                            </div>
                            ${moreButton}
                        </div>
                    </div>

                    <!-- Action Button at the bottom -->
                    <div class="mt-4 pt-4 border-t">
                        <button 
                            onclick="investigateLead('${lead.business_name.replace(/'/g, "\\'")}', '${lead.location.replace(/'/g, "\\'")}')"
                            class="w-full py-2 text-sm font-medium text-white bg-blue-500 rounded-lg shadow-md hover:bg-blue-600 transition duration-150"
                        >
                            Investigate in Google
                        </button>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });
            resultsSection.classList.remove('hidden');
        }

        async function handleGenerateLeads() {
            const query = nicheInput.value.trim() || nicheInput.placeholder;

            // UI State: Loading
            errorMsg.classList.add('hidden');
            resultsSection.classList.add('hidden');
            investigationOutput.classList.add('hidden'); // Hide investigation output when generating new leads
            generateButton.disabled = true;
            generateMoreButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            generateButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyzing...`;
            
            try {
                // Perform the search and analysis
                const leads = await simulateGoogleSearch(query);

                if (leads && leads.length > 0) {
                    renderResults(leads);
                } else {
                    resultsHeader.textContent = `Prospects Found (0 Businesses)`;
                    errorMsg.textContent = "Search completed, but no relevant leads could be identified based on the query. Please try a different niche or location.";
                    errorMsg.classList.remove('hidden');
                    resultsSection.classList.remove('hidden'); // Show section even if empty to show the 0 count
                }
            } catch (error) {
                console.error("Lead generation failed:", error);
                
                // --- Display a user-friendly error message ---
                if (error.message.includes("Failed to get live leads")) {
                    errorMsg.textContent = "Live lead search failed. Please try again with a different, less complex query (e.g., 'Bakeries in Sydney' instead of 'Vintage Bookstores near downtown Berlin'). Displaying fallback data for now.";
                    renderResults(SIMULATED_LEADS);
                } else {
                    errorMsg.textContent = "An unknown error occurred during the lead analysis. Check the console for details.";
                }
                errorMsg.classList.remove('hidden');
                
            } finally {
                // UI State: Done
                loadingIndicator.classList.add('hidden');
                generateButton.disabled = false;
                generateMoreButton.disabled = false;
                generateButton.innerHTML = 'Generate 10 Leads';
            }
        }

        function toggleJsonView() {
            const isActive = jsonOutput.classList.toggle('active');
            chevronIcon.classList.toggle('rotate-180', isActive);
            
            const newText = isActive ? 'Hide Raw JSON Data' : 'View Raw JSON Data';
            const chevronHtml = `<svg class="w-4 h-4 ml-1 transform ${isActive ? 'rotate-180' : ''} transition duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;

            toggleJsonButton.innerHTML = newText + chevronHtml;
        }

        generateButton.addEventListener('click', handleGenerateLeads);
        generateMoreButton.addEventListener('click', handleGenerateLeads); // Hooking up the new button
        toggleJsonButton.addEventListener('click', toggleJsonView);
        closeModalButton.addEventListener('click', () => reasonModal.classList.add('hidden'));
        reasonModal.addEventListener('click', (e) => {
            if (e.target === reasonModal) {
                reasonModal.classList.add('hidden');
            }
        });

